#!/usr/bin/env bash
#
# Run the APALACHE model checker
#
# Igor Konnov, 2018

DIR=`dirname $0`
DIR=`cd "$DIR/.."; pwd`
echo "# Tool home: $DIR"
# try to find a release file first
JAR=`find "$DIR" -maxdepth 1 -name "apalache-pkg-*-full.jar" | head -n 1`

if [ ! -f "$JAR" ]; then
    # try to find a package file
    JAR=`find "$DIR/mod-distribution/target/" -maxdepth 1 -name "apalache-pkg-*-full.jar" | head -n 1`
    if [ ! -f "$JAR" ]; then
        echo "ERROR: Distribution jar not found. Did you run mvn package?"
        exit 1
    fi
fi

echo "# Package:   $JAR"

# the maximum heap size, Z3 will use much more as a native library
JVM_ARGS="-Xmx4096m"
# uncomment to track memory usage with: jcmd <pid> VM.native_memory summary
#JVM_ARGS="${JVM_ARGS} -XX:NativeMemoryTracking=summary"

echo "# JVM args: $JVM_ARGS"
echo "#"

# a trap for SIGINT and SIGTERM
sigterm() {
    echo "Premature termination requested. Killing apalache-mc (pid $child)" 1>&2
    trap - SIGTERM SIGINT # unregister to avoid recursion below
    # send termination to the child process
    kill SIGTERM $child 2>/dev/null
}

trap sigterm SIGTERM SIGINT

# run java in the background in order to react to SIGTERM
java $JVM_ARGS -jar "$JAR" "$@" &
child=$!
wait "$child"

